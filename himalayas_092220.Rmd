---
title: "Tidy Tuesday : Himalayan Climbing Dataset"
author: "Namita Trikannad"
date: "9/22/2020"
output: html_document
---

```{r setup, include=FALSE}
# set default knitr chunks
knitr::opts_chunk$set(
  tidy.opts=list(width.cutoff=60),tidy=TRUE,
  echo = FALSE,  # don't print the code chunk
  results = 'hide',
  warning = FALSE,  # don't print warnings
  message = FALSE,  # don't print messages
  fig.width = 8,  # set default width of figures
  fig.height = 6,  # set default height of figures
  fig.align = "center",  # always align figure in center
  fig.pos = "H",  # always plot figure at the exact location of the code chunk
  cache = F)  # don't cache results  #CHANGE THIS TO "FALSE" AFTER YOU'RE DONE !!

#Remove this 
setwd("GitHub/TidyTuesday")
```

```{r libraries}
library(tidytuesdayR)
library(viridis)
library(ggthemes)
library(broom)
library(scatterpie)

theme_set(theme_classic())
```

```{r read}
dat <- tidytuesdayR::tt_load('2020-09-22')
```

```{r}
peaks <- dat$peaks
members <- dat$members
exped <- dat$expeditions
rm(dat)
```

```{r}
colSums(is.na(peaks))
colSums(is.na(members))
colSums(is.na(exped))
```
The missing data are missing based on other data such as, if the climb failed then the date to highest point is NA etc. 

Let's look at the distribution of heights and the names of the highes peaks 
```{r}
peaks %>% 
  dplyr::arrange(desc(height_metres)) %>% 
  mutate(peak_name = fct_reorder(peak_name, height_metres, .desc = T)) %>%
  head(20) %>% 
  ggplot(aes(height_metres, peak_name)) + 
  geom_col() +
  labs(title = "Top 20 highest peaks",
       x = "Height(metres)",
       y = "")

# Top highest unclimbed mountains 
peaks %>% 
  filter(climbing_status == "Unclimbed") %>% 
  arrange(desc(height_metres)) %>% 
  head(20) %>% 
  mutate(peak_name = fct_reorder(peak_name, height_metres)) %>% 
  ggplot(aes(height_metres, peak_name)) + 
  geom_col() +
  labs(title = "Highest peaks in the Himalayas that remain unclimbed",
       x = "Height(metres)",
       y = "")

```
1. Top termination reasons by peak and season. Which season has the best success rate and by peak. 
2. 
```{r}
exped_top20 <- exped %>% 
  group_by(peak_id, peak_name) %>%  
  summarize(n_climbs = n(),
            across(members:hired_staff_deaths, sum)) %>% 
  ungroup() %>% 
  filter(n_climbs > 50) %>% 
  mutate(total_climbers = members + hired_staff,
         total_deaths = member_deaths +  hired_staff_deaths,
         pct_deaths = total_deaths/total_climbers, 
         pct_member_deaths = member_deaths / members,
         pct_hired_staff_deaths = hired_staff_deaths /hired_staff,
         peak_name = fct_reorder(peak_name, pct_deaths)) %>% 
  arrange(desc(pct_deaths)) %>%
  select(peak_name, n_climbs, pct_deaths, pct_member_deaths, pct_hired_staff_deaths) 

```

Fatality rate of the top20 most frequently climbed peaks in Himalayas 
```{r}
exped_top20 %>% 
  gather("climber_type", "pct_deaths",-peak_name, -n_climbs, pct_member_deaths:pct_hired_staff_deaths) %>%
  mutate(climber_type = ifelse(climber_type == "pct_member_deaths", "Member", "Hired")) %>%
  ggplot() +
  geom_col(aes(pct_deaths, peak_name, fill = climber_type)) + 
  labs(x = "Fatality rate",
       y = "", 
       title = "Deadliest of the most climbed peaks in the Himalayas", 
       subtitle = "Showing peaks climbed atleast 50 times since 1905") +
  scale_x_continuous(labels = scales::percent) +
  scale_fill_manual(values = c("gray27","gray42")) +
  theme(legend.title = element_blank())

```

Moving on from the topic of death, let's try to use a model to see what are the chances of success to climb one of these deadliest most frequently climbed peaks 
```{r}
my_peaks <- exped_top20 %>% pull(peak_name) %>% droplevels()

a <- peaks %>% 
  select(peak_id, peak_name, height_metres) %>% 
  filter(peak_name %in% my_peaks)

b <- exped %>% 
  select(expedition_id, peak_name, season, members, hired_staff) %>% 
  filter(peak_name %in% my_peaks)

c <- members %>% 
  select(expedition_id, member_id, peak_name, sex, age, expedition_role, hired, solo, oxygen_used, success) %>% 
  filter(peak_name %in% my_peaks)

df <- left_join(b, a, by = "peak_name") %>%
  left_join(., c, by = c("expedition_id", "peak_name")) %>% 
  filter(!is.na(member_id)) %>% 
  mutate(expedition_role = ifelse(expedition_role %in% c("Climber", "H-A Worker", "Leader", "Exp Doctor", "Deputy Leader"), expedition_role, "Other")) %>% 
  mutate(leader = expedition_role == "Leader") %>% 
  mutate(springtime_climb = season == "Spring")
```

```{r}
df %>% 
  filter(peak_name == "Annapurna I") %>% 
  glm(success ~ springtime_climb + members + hired_staff + height_metres + leader + hired + solo + oxygen_used, data = ., family = "binomial") %>% 
  tidy(conf.int = T) %>% 
  mutate(p.value = format.pval(p.value)) %>% 
  filter(term != "(Intercept)") %>% 
  ggplot(aes(estimate, term)) +
  geom_point() +
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high))+
  labs(title = "Estimate of success based on features of an expedition", 
       subtitle = "Results showing for Annapurna I")
```

# Links to interesting tidy tuesday plots from Twitter
https://github.com/joseph-shaw/tidytuesday/blob/master/2020-09-22_Everest/2020-09-22_Mountains.R

https://github.com/kaustavSen/tidytuesday/blob/master/2020/week_39_himalayas.Rmd









